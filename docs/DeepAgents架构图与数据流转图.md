# DeepAgentsæ¶æ„å›¾ä¸æ•°æ®æµè½¬å›¾

> **ç‰ˆæœ¬**: v1.0-20251017123000
> **æœ€åæ›´æ–°**: 2025-10-17
> **éµå¾ªåŸåˆ™**: KISS (Keep It Simple, Stupid) & DRY (Don't Repeat Yourself)

---

## ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [æ¨¡å—ç»“æ„å›¾](#æ¨¡å—ç»“æ„å›¾)
3. [æ•°æ®æµè½¬å›¾](#æ•°æ®æµè½¬å›¾)
4. [ä¸­é—´ä»¶ç®¡é“](#ä¸­é—´ä»¶ç®¡é“)
5. [SubAgent è°ƒç”¨æµç¨‹](#subagent-è°ƒç”¨æµç¨‹)
6. [æ ¸å¿ƒç»„ä»¶è¯¦è§£](#æ ¸å¿ƒç»„ä»¶è¯¦è§£)
7. [Linus å¼ä»£ç å“å‘³åˆ†æ](#linus-å¼ä»£ç å“å‘³åˆ†æ)

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### é«˜å±‚æ¶æ„ (ä»ä¸Šåˆ°ä¸‹)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·å±‚                                â”‚
â”‚         (User Input: messages, files, configs)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API å…¥å£å±‚                               â”‚
â”‚   create_deep_agent() / async_create_deep_agent()           â”‚
â”‚                  (graph.py)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Agent Builder å±‚                            â”‚
â”‚      agent_builder(tools, instructions, middleware...)       â”‚
â”‚         - ç»„è£…ä¸­é—´ä»¶æ ˆ                                         â”‚
â”‚         - é…ç½®ç³»ç»Ÿæç¤ºè¯                                        â”‚
â”‚         - åˆ›å»º LangGraph Agent                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸­é—´ä»¶æ ˆ (Middleware Stack)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. PlanningMiddleware                                â”‚   â”‚
â”‚  â”‚    - State: todos[]                                  â”‚   â”‚
â”‚  â”‚    - Tool: write_todos                               â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ 2. FilesystemMiddleware                              â”‚   â”‚
â”‚  â”‚    - State: files{path: content}                     â”‚   â”‚
â”‚  â”‚    - Tools: ls, read_file, write_file, edit_file     â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ 3. SubAgentMiddleware                                â”‚   â”‚
â”‚  â”‚    - Tool: task(description, subagent_type)          â”‚   â”‚
â”‚  â”‚    - ç®¡ç† SubAgent ç”Ÿå‘½å‘¨æœŸ                           â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ 4. SummarizationMiddleware                           â”‚   â”‚
â”‚  â”‚    - å½“ tokens > 120k æ—¶è‡ªåŠ¨æ‘˜è¦                       â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ 5. AnthropicPromptCachingMiddleware                  â”‚   â”‚
â”‚  â”‚    - æç¤ºè¯ç¼“å­˜ (TTL: 5min)                           â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ 6. HumanInTheLoopMiddleware (å¯é€‰)                    â”‚   â”‚
â”‚  â”‚    - å·¥å…·è°ƒç”¨æ‹¦æˆªä¸å®¡æ‰¹                                â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ 7. Custom Middleware (ç”¨æˆ·è‡ªå®šä¹‰)                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               LangGraph Agent æ ¸å¿ƒ                            â”‚
â”‚   create_agent(model, system_prompt, tools, middleware)     â”‚
â”‚         - çŠ¶æ€ç®¡ç† (State Graph)                              â”‚
â”‚         - å·¥å…·è·¯ç”±                                            â”‚
â”‚         - æ¶ˆæ¯å¾ªç¯                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å·¥å…·å±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   å†…ç½®å·¥å…·      â”‚    ç”¨æˆ·å·¥å…·       â”‚   SubAgents    â”‚    â”‚
â”‚  â”‚                â”‚                  â”‚                â”‚    â”‚
â”‚  â”‚ â€¢ write_todos  â”‚ â€¢ internet_searchâ”‚ â€¢ general-     â”‚    â”‚
â”‚  â”‚ â€¢ ls           â”‚ â€¢ custom_tools   â”‚   purpose      â”‚    â”‚
â”‚  â”‚ â€¢ read_file    â”‚ â€¢ ...            â”‚ â€¢ research-    â”‚    â”‚
â”‚  â”‚ â€¢ write_file   â”‚                  â”‚   analyst      â”‚    â”‚
â”‚  â”‚ â€¢ edit_file    â”‚                  â”‚ â€¢ custom       â”‚    â”‚
â”‚  â”‚                â”‚                  â”‚   subagents    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ¨¡å‹å±‚                                    â”‚
â”‚    LLM (é»˜è®¤: claude-sonnet-4-20250514)                      â”‚
â”‚    - æ”¯æŒè‡ªå®šä¹‰æ¨¡å‹                                            â”‚
â”‚    - æ”¯æŒ per-subagent æ¨¡å‹è¦†ç›–                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ¨¡å—ç»“æ„å›¾

```
src/deepagents/
â”‚
â”œâ”€â”€ __init__.py                  # å¯¼å‡ºå…¬å…± API
â”‚   â”œâ”€â”€ create_deep_agent
â”‚   â”œâ”€â”€ async_create_deep_agent
â”‚   â”œâ”€â”€ PlanningMiddleware
â”‚   â”œâ”€â”€ FilesystemMiddleware
â”‚   â”œâ”€â”€ SubAgentMiddleware
â”‚   â”œâ”€â”€ DeepAgentState
â”‚   â”œâ”€â”€ SubAgent
â”‚   â””â”€â”€ CustomSubAgent
â”‚
â”œâ”€â”€ graph.py                     # Agent æ„å»ºå™¨
â”‚   â”œâ”€â”€ agent_builder()          # ç»Ÿä¸€æ„å»ºå™¨ (åŒæ­¥/å¼‚æ­¥)
â”‚   â”œâ”€â”€ create_deep_agent()      # åŒæ­¥ API
â”‚   â””â”€â”€ async_create_deep_agent()# å¼‚æ­¥ API
â”‚
â”œâ”€â”€ middleware.py                # ä¸‰å¤§æ ¸å¿ƒä¸­é—´ä»¶
â”‚   â”œâ”€â”€ PlanningMiddleware       # TODO è§„åˆ’
â”‚   â”œâ”€â”€ FilesystemMiddleware     # è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
â”‚   â”œâ”€â”€ SubAgentMiddleware       # å­ä»£ç†ç®¡ç†
â”‚   â”œâ”€â”€ _get_agents()            # SubAgent å®ä¾‹åŒ–
â”‚   â”œâ”€â”€ _get_subagent_description()
â”‚   â””â”€â”€ create_task_tool()       # åŠ¨æ€åˆ›å»º task å·¥å…·
â”‚
â”œâ”€â”€ state.py                     # çŠ¶æ€å®šä¹‰
â”‚   â”œâ”€â”€ DeepAgentState           # å®Œæ•´çŠ¶æ€ (todos + files)
â”‚   â”œâ”€â”€ PlanningState            # è§„åˆ’çŠ¶æ€ (todos)
â”‚   â”œâ”€â”€ FilesystemState          # æ–‡ä»¶ç³»ç»ŸçŠ¶æ€ (files)
â”‚   â”œâ”€â”€ Todo (TypedDict)         # TODO æ•°æ®ç»“æ„
â”‚   â””â”€â”€ file_reducer()           # æ–‡ä»¶çŠ¶æ€åˆå¹¶å‡½æ•°
â”‚
â”œâ”€â”€ tools.py                     # å†…ç½®å·¥å…·å®ç°
â”‚   â”œâ”€â”€ write_todos()            # å†™å…¥ TODO åˆ—è¡¨
â”‚   â”œâ”€â”€ ls()                     # åˆ—å‡ºæ–‡ä»¶
â”‚   â”œâ”€â”€ read_file()              # è¯»æ–‡ä»¶ (æ”¯æŒ offset/limit)
â”‚   â”œâ”€â”€ write_file()             # å†™æ–‡ä»¶
â”‚   â””â”€â”€ edit_file()              # ç¼–è¾‘æ–‡ä»¶ (å­—ç¬¦ä¸²æ›¿æ¢)
â”‚
â”œâ”€â”€ types.py                     # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ SubAgent (TypedDict)     # åŸºäº Prompt çš„ SubAgent
â”‚   â””â”€â”€ CustomSubAgent (TypedDict)# åŸºäº Graph çš„ SubAgent
â”‚
â”œâ”€â”€ prompts.py                   # ç³»ç»Ÿæç¤ºè¯åº“ (25k+ å­—ç¬¦)
â”‚   â”œâ”€â”€ BASE_AGENT_PROMPT
â”‚   â”œâ”€â”€ WRITE_TODOS_SYSTEM_PROMPT
â”‚   â”œâ”€â”€ TASK_SYSTEM_PROMPT
â”‚   â”œâ”€â”€ FILESYSTEM_SYSTEM_PROMPT
â”‚   â”œâ”€â”€ WRITE_TODOS_TOOL_DESCRIPTION
â”‚   â”œâ”€â”€ TASK_TOOL_DESCRIPTION
â”‚   â””â”€â”€ ... (æ–‡ä»¶ç³»ç»Ÿå·¥å…·æè¿°)
â”‚
â””â”€â”€ model.py                     # é»˜è®¤æ¨¡å‹é…ç½®
    â””â”€â”€ get_default_model()      # è¿”å› claude-sonnet-4-20250514
```

---

## æ•°æ®æµè½¬å›¾

### å®Œæ•´è¯·æ±‚-å“åº”å¾ªç¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·å‘èµ·è¯·æ±‚                                                  â”‚
â”‚  agent.invoke({                                              â”‚
â”‚      "messages": [{"role": "user", "content": "..."}],       â”‚
â”‚      "files": {"doc.txt": "initial content"}  # å¯é€‰         â”‚
â”‚  })                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: çŠ¶æ€åˆå§‹åŒ–                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ DeepAgentState {                                   â”‚    â”‚
â”‚  â”‚   messages: [UserMessage],                         â”‚    â”‚
â”‚  â”‚   todos: [],                                       â”‚    â”‚
â”‚  â”‚   files: {"doc.txt": "..."}                        â”‚    â”‚
â”‚  â”‚ }                                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: ä¸­é—´ä»¶é¢„å¤„ç† (Pre-Model Hooks)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ modify_model_request() è°ƒç”¨é“¾:                     â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ 1. PlanningMiddleware:                             â”‚    â”‚
â”‚  â”‚    system_prompt += WRITE_TODOS_SYSTEM_PROMPT      â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ 2. FilesystemMiddleware:                           â”‚    â”‚
â”‚  â”‚    system_prompt += FILESYSTEM_SYSTEM_PROMPT       â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ 3. SubAgentMiddleware:                             â”‚    â”‚
â”‚  â”‚    system_prompt += TASK_SYSTEM_PROMPT             â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ æœ€ç»ˆæç¤ºè¯ = user_instructions +                   â”‚    â”‚
â”‚  â”‚              BASE_AGENT_PROMPT +                   â”‚    â”‚
â”‚  â”‚              ä¸­é—´ä»¶ç³»ç»Ÿæç¤ºè¯                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: LLM æ¨ç†                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ è¾“å…¥:                                               â”‚    â”‚
â”‚  â”‚   - å®Œæ•´ç³»ç»Ÿæç¤ºè¯                                   â”‚    â”‚
â”‚  â”‚   - æ¶ˆæ¯å†å²                                        â”‚    â”‚
â”‚  â”‚   - å¯ç”¨å·¥å…·åˆ—è¡¨ (å†…ç½® + ç”¨æˆ·)                       â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ è¾“å‡º:                                               â”‚    â”‚
â”‚  â”‚   - AIMessage with tool_calls                      â”‚    â”‚
â”‚  â”‚   OR                                               â”‚    â”‚
â”‚  â”‚   - AIMessage with content (æœ€ç»ˆå“åº”)               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: å·¥å…·è°ƒç”¨è·¯ç”±                                         â”‚
â”‚                                                              â”‚
â”‚  å¦‚æœ tool_calls å­˜åœ¨:                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰ tool_calls:                            â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ â€¢ write_todos â†’ æ›´æ–° state.todos                   â”‚    â”‚
â”‚  â”‚ â€¢ read_file   â†’ è¿”å›æ–‡ä»¶å†…å®¹                        â”‚    â”‚
â”‚  â”‚ â€¢ write_file  â†’ æ›´æ–° state.files                   â”‚    â”‚
â”‚  â”‚ â€¢ edit_file   â†’ æ›´æ–° state.files                   â”‚    â”‚
â”‚  â”‚ â€¢ task        â†’ å¯åŠ¨ SubAgent (è§ä¸‹å›¾)             â”‚    â”‚
â”‚  â”‚ â€¢ internet_search â†’ è¿”å›æœç´¢ç»“æœ                    â”‚    â”‚
â”‚  â”‚ â€¢ ... å…¶ä»–ç”¨æˆ·å·¥å…·                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: çŠ¶æ€æ›´æ–°                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ DeepAgentState {                                   â”‚    â”‚
â”‚  â”‚   messages: [                                      â”‚    â”‚
â”‚  â”‚     UserMessage,                                   â”‚    â”‚
â”‚  â”‚     AIMessage(tool_calls=[...]),                   â”‚    â”‚
â”‚  â”‚     ToolMessage(name="write_todos", ...),          â”‚    â”‚
â”‚  â”‚     ToolMessage(name="read_file", ...)             â”‚    â”‚
â”‚  â”‚   ],                                               â”‚    â”‚
â”‚  â”‚   todos: [                                         â”‚    â”‚
â”‚  â”‚     {content: "åˆ†æä»£ç ", status: "in_progress"},   â”‚    â”‚
â”‚  â”‚     {content: "å†™æŠ¥å‘Š", status: "pending"}          â”‚    â”‚
â”‚  â”‚   ],                                               â”‚    â”‚
â”‚  â”‚   files: {                                         â”‚    â”‚
â”‚  â”‚     "doc.txt": "...",                              â”‚    â”‚
â”‚  â”‚     "report.md": "æ–°ç”Ÿæˆçš„æŠ¥å‘Šå†…å®¹"                 â”‚    â”‚
â”‚  â”‚   }                                                â”‚    â”‚
â”‚  â”‚ }                                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ å¾ªç¯å› Step 2 (ç›´åˆ° LLM ä¸å†è°ƒç”¨å·¥å…·)
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 6: æœ€ç»ˆå“åº”                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ è¿”å›å®Œæ•´çŠ¶æ€:                                       â”‚    â”‚
â”‚  â”‚ {                                                  â”‚    â”‚
â”‚  â”‚   "messages": [...],  # å®Œæ•´å¯¹è¯å†å²                â”‚    â”‚
â”‚  â”‚   "todos": [...],     # æœ€ç»ˆ TODO åˆ—è¡¨              â”‚    â”‚
â”‚  â”‚   "files": {...}      # æ‰€æœ‰æ–‡ä»¶ï¼ˆå«æ–°ç”Ÿæˆçš„ï¼‰       â”‚    â”‚
â”‚  â”‚ }                                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸­é—´ä»¶ç®¡é“

### ä¸­é—´ä»¶æ‰§è¡Œæ—¶åºå›¾

```
Time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶

Request In
    â”‚
    â”œâ”€â”€â–º PlanningMiddleware.modify_model_request()
    â”‚       â”‚
    â”‚       â””â”€â–º æ³¨å…¥ WRITE_TODOS_SYSTEM_PROMPT
    â”‚       â””â”€â–º æ³¨å†Œ write_todos å·¥å…·
    â”‚
    â”œâ”€â”€â–º FilesystemMiddleware.modify_model_request()
    â”‚       â”‚
    â”‚       â””â”€â–º æ³¨å…¥ FILESYSTEM_SYSTEM_PROMPT
    â”‚       â””â”€â–º æ³¨å†Œ ls, read_file, write_file, edit_file
    â”‚
    â”œâ”€â”€â–º SubAgentMiddleware.modify_model_request()
    â”‚       â”‚
    â”‚       â””â”€â–º æ³¨å…¥ TASK_SYSTEM_PROMPT
    â”‚       â””â”€â–º æ³¨å†Œ task å·¥å…·
    â”‚       â””â”€â–º åˆå§‹åŒ– SubAgent æ±  (general-purpose + custom)
    â”‚
    â”œâ”€â”€â–º SummarizationMiddleware.modify_model_request()
    â”‚       â”‚
    â”‚       â””â”€â–º æ£€æŸ¥ token ä½¿ç”¨é‡
    â”‚       â””â”€â–º å¦‚æœ > 120k tokensï¼Œè§¦å‘æ‘˜è¦
    â”‚
    â”œâ”€â”€â–º AnthropicPromptCachingMiddleware.modify_model_request()
    â”‚       â”‚
    â”‚       â””â”€â–º æ·»åŠ ç¼“å­˜æ ‡è®°åˆ°ç³»ç»Ÿæç¤ºè¯
    â”‚
    â”œâ”€â”€â–º HumanInTheLoopMiddleware (å¦‚æœé…ç½®)
    â”‚       â”‚
    â”‚       â””â”€â–º æ‹¦æˆªé…ç½®çš„å·¥å…·è°ƒç”¨
    â”‚       â””â”€â–º ç­‰å¾…äººå·¥å®¡æ‰¹ (accept/edit/respond)
    â”‚
    â””â”€â”€â–º å‘é€åˆ° LLM
           â”‚
           â””â”€â”€â–º Model Response
                  â”‚
                  â”œâ”€â”€â–º å·¥å…·è°ƒç”¨æ‰§è¡Œ
                  â”‚
                  â””â”€â”€â–º çŠ¶æ€æ›´æ–°
```

### å…³é”®æ•°æ®ç»“æ„ä¼ é€’

```python
# ModelRequest å¯¹è±¡åœ¨ä¸­é—´ä»¶é“¾ä¸­ä¼ é€’
class ModelRequest:
    system_prompt: str        # ç´¯ç§¯å¢é•¿çš„ç³»ç»Ÿæç¤ºè¯
    messages: list[Message]   # å¯¹è¯å†å²
    tools: list[Tool]         # ç´¯ç§¯å¢é•¿çš„å·¥å…·åˆ—è¡¨
    ...

# æ¯ä¸ªä¸­é—´ä»¶çš„ modify_model_request æ¥æ”¶å¹¶ä¿®æ”¹è¿™ä¸ªå¯¹è±¡
def modify_model_request(
    self,
    request: ModelRequest,      # è¾“å…¥ï¼šå½“å‰è¯·æ±‚çŠ¶æ€
    agent_state: AgentState,    # è¾“å…¥ï¼šå½“å‰ä»£ç†çŠ¶æ€
    runtime: Runtime            # è¿è¡Œæ—¶ç¯å¢ƒ
) -> ModelRequest:              # è¾“å‡ºï¼šä¿®æ”¹åçš„è¯·æ±‚
    request.system_prompt += self.extra_prompt
    return request
```

---

## SubAgent è°ƒç”¨æµç¨‹

### Task å·¥å…·è°ƒç”¨çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ

```
Main Agent å†³å®šè°ƒç”¨ task å·¥å…·
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  task(                                                       â”‚
â”‚      description="æ·±å…¥ç ”ç©¶ LangGraph æ¶æ„",                   â”‚
â”‚      subagent_type="general-purpose"                         â”‚
â”‚  )                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: SubAgent é€‰æ‹©                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ä» SubAgent æ± ä¸­æŸ¥æ‰¾ "general-purpose":             â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ agents = {                                         â”‚    â”‚
â”‚  â”‚   "general-purpose": <Agent>,  # é»˜è®¤å­˜åœ¨          â”‚    â”‚
â”‚  â”‚   "research-analyst": <Agent>, # ç”¨æˆ·è‡ªå®šä¹‰        â”‚    â”‚
â”‚  â”‚   "code-reviewer": <Agent>     # ç”¨æˆ·è‡ªå®šä¹‰        â”‚    â”‚
â”‚  â”‚ }                                                  â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ å¦‚æœ subagent_type ä¸å­˜åœ¨ â†’ è¿”å›é”™è¯¯                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: SubAgent çŠ¶æ€éš”ç¦»                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ åˆ›å»ºç‹¬ç«‹çŠ¶æ€:                                       â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ sub_state = {                                      â”‚    â”‚
â”‚  â”‚   "messages": [                                    â”‚    â”‚
â”‚  â”‚     {                                              â”‚    â”‚
â”‚  â”‚       "role": "user",                              â”‚    â”‚
â”‚  â”‚       "content": "æ·±å…¥ç ”ç©¶ LangGraph æ¶æ„"          â”‚    â”‚
â”‚  â”‚     }                                              â”‚    â”‚
â”‚  â”‚   ],                                               â”‚    â”‚
â”‚  â”‚   "files": {...},  # ä»ä¸» Agent ç»§æ‰¿                â”‚    â”‚
â”‚  â”‚   "todos": []      # SubAgent ç‹¬ç«‹çš„ TODO          â”‚    â”‚
â”‚  â”‚ }                                                  â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ æ³¨æ„: SubAgent çš„ messages æ˜¯å…¨æ–°çš„ï¼Œ               â”‚    â”‚
â”‚  â”‚      ä¸åŒ…å«ä¸» Agent çš„å¯¹è¯å†å²                       â”‚    â”‚
â”‚  â”‚      â†’ å®ç° "context quarantine"                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: SubAgent æ‰§è¡Œ                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ sub_agent.invoke(sub_state)                        â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ SubAgent è‡ªèº«ä¹Ÿæœ‰å®Œæ•´çš„ä¸­é—´ä»¶æ ˆ:                    â”‚    â”‚
â”‚  â”‚ â€¢ PlanningMiddleware                               â”‚    â”‚
â”‚  â”‚ â€¢ FilesystemMiddleware                             â”‚    â”‚
â”‚  â”‚ â€¢ SummarizationMiddleware                          â”‚    â”‚
â”‚  â”‚ â€¢ AnthropicPromptCachingMiddleware                 â”‚    â”‚
â”‚  â”‚ â€¢ (æ³¨æ„: SubAgent é»˜è®¤ *æ²¡æœ‰* SubAgentMiddleware)   â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ SubAgent å¯ä»¥:                                     â”‚    â”‚
â”‚  â”‚ â€¢ è°ƒç”¨å·¥å…·                                          â”‚    â”‚
â”‚  â”‚ â€¢ æ›´æ–° todos                                       â”‚    â”‚
â”‚  â”‚ â€¢ è¯»å†™æ–‡ä»¶                                          â”‚    â”‚
â”‚  â”‚ â€¢ è¿›è¡Œå¤šè½®æ¨ç†                                      â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ æœ€ç»ˆè¿”å›:                                           â”‚    â”‚
â”‚  â”‚ {                                                  â”‚    â”‚
â”‚  â”‚   "messages": [                                    â”‚    â”‚
â”‚  â”‚     UserMessage("æ·±å…¥ç ”ç©¶ LangGraph æ¶æ„"),         â”‚    â”‚
â”‚  â”‚     AIMessage(...),                                â”‚    â”‚
â”‚  â”‚     ToolMessage(...),                              â”‚    â”‚
â”‚  â”‚     ...,                                           â”‚    â”‚
â”‚  â”‚     AIMessage("ç ”ç©¶å®Œæˆï¼Œä»¥ä¸‹æ˜¯è¯¦ç»†æŠ¥å‘Š...")        â”‚    â”‚
â”‚  â”‚   ],                                               â”‚    â”‚
â”‚  â”‚   "files": {"research_report.md": "..."}           â”‚    â”‚
â”‚  â”‚ }                                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: ç»“æœæå–ä¸çŠ¶æ€åˆå¹¶                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ # åªå– SubAgent æœ€åä¸€æ¡æ¶ˆæ¯ä½œä¸ºå·¥å…·è¿”å›å€¼          â”‚    â”‚
â”‚  â”‚ tool_result = result["messages"][-1].content       â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ # åˆå¹¶éæ¶ˆæ¯çŠ¶æ€ (å¦‚ files)                         â”‚    â”‚
â”‚  â”‚ state_update = {}                                  â”‚    â”‚
â”‚  â”‚ for k, v in result.items():                        â”‚    â”‚
â”‚  â”‚     if k not in ["todos", "messages"]:             â”‚    â”‚
â”‚  â”‚         state_update[k] = v  # å¦‚ files            â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ # è¿”å› Command æ›´æ–°ä¸» Agent çŠ¶æ€                    â”‚    â”‚
â”‚  â”‚ return Command(                                    â”‚    â”‚
â”‚  â”‚     update={                                       â”‚    â”‚
â”‚  â”‚         **state_update,  # files æ›´æ–°              â”‚    â”‚
â”‚  â”‚         "messages": [                              â”‚    â”‚
â”‚  â”‚             ToolMessage(                           â”‚    â”‚
â”‚  â”‚                 content=tool_result,               â”‚    â”‚
â”‚  â”‚                 tool_call_id=...                   â”‚    â”‚
â”‚  â”‚             )                                      â”‚    â”‚
â”‚  â”‚         ]                                          â”‚    â”‚
â”‚  â”‚     }                                              â”‚    â”‚
â”‚  â”‚ )                                                  â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ æ³¨æ„: SubAgent çš„ä¸­é—´æ¨ç†è¿‡ç¨‹è¢«ä¸¢å¼ƒï¼Œ                â”‚    â”‚
â”‚  â”‚      åªä¿ç•™æœ€ç»ˆè¾“å‡º â†’ èŠ‚çœä¸» Agent ä¸Šä¸‹æ–‡             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: ä¸» Agent ç»§ç»­                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ä¸» Agent çœ‹åˆ°çš„æ¶ˆæ¯å†å²:                            â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ [                                                  â”‚    â”‚
â”‚  â”‚   UserMessage("å¸®æˆ‘ç ”ç©¶ä¸‰ä¸ªæŠ€æœ¯"),                  â”‚    â”‚
â”‚  â”‚   AIMessage(tool_calls=[                           â”‚    â”‚
â”‚  â”‚     {"name": "task", "args": {...}}                â”‚    â”‚
â”‚  â”‚   ]),                                              â”‚    â”‚
â”‚  â”‚   ToolMessage(                                     â”‚    â”‚
â”‚  â”‚     name="task",                                   â”‚    â”‚
â”‚  â”‚     content="ç ”ç©¶å®Œæˆï¼ŒLangGraph æ˜¯..."  # æµ“ç¼©ç»“æœ â”‚    â”‚
â”‚  â”‚   )                                                â”‚    â”‚
â”‚  â”‚ ]                                                  â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ ä¸» Agent *çœ‹ä¸åˆ°* SubAgent çš„:                      â”‚    â”‚
â”‚  â”‚ â€¢ ä¸­é—´å·¥å…·è°ƒç”¨                                      â”‚    â”‚
â”‚  â”‚ â€¢ æ¨ç†æ­¥éª¤                                          â”‚    â”‚
â”‚  â”‚ â€¢ SubAgent çš„ todos                                â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ â†’ è¿™å°±æ˜¯ "context quarantine" çš„å®ç°               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SubAgent å¹¶è¡Œè°ƒç”¨ç¤ºä¾‹

```python
# ç”¨æˆ·è¯·æ±‚: "ç ”ç©¶ LangGraph, LangChain, LangSmith"

# Main Agent çš„å•æ¬¡å·¥å…·è°ƒç”¨:
AIMessage(tool_calls=[
    {
        "name": "task",
        "args": {
            "description": "ç ”ç©¶ LangGraph æ¶æ„å’Œæ ¸å¿ƒæ¦‚å¿µ",
            "subagent_type": "general-purpose"
        }
    },
    {
        "name": "task",
        "args": {
            "description": "ç ”ç©¶ LangChain åŠŸèƒ½å’Œç”Ÿæ€",
            "subagent_type": "general-purpose"
        }
    },
    {
        "name": "task",
        "args": {
            "description": "ç ”ç©¶ LangSmith ç›‘æ§èƒ½åŠ›",
            "subagent_type": "general-purpose"
        }
    }
])

# è¿™ä¸‰ä¸ª SubAgent å¹¶è¡Œæ‰§è¡Œï¼Œå„è‡ªç‹¬ç«‹:
# â€¢ ç‹¬ç«‹çš„æ¶ˆæ¯å†å²
# â€¢ ç‹¬ç«‹çš„ todos
# â€¢ å…±äº«çš„ files (é€šè¿‡ State)
# â€¢ æœ€ç»ˆè¿”å›ä¸‰ä¸ªç‹¬ç«‹çš„ ToolMessage
```

---

## æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. State ç®¡ç†

```python
# state.py

class Todo(TypedDict):
    content: str                                      # TODO å†…å®¹
    status: Literal["pending", "in_progress", "completed"]  # çŠ¶æ€

class DeepAgentState(AgentState):
    todos: NotRequired[list[Todo]]                    # TODO åˆ—è¡¨
    files: Annotated[NotRequired[dict[str, str]], file_reducer]
    #      ^^^^^^^^^                               ^^^^^^^^^^^^
    #      å¯é€‰å­—æ®µ                                 è‡ªå®šä¹‰åˆå¹¶å‡½æ•°

def file_reducer(left, right):
    """åˆå¹¶æ–‡ä»¶å­—å…¸çš„ Reducer"""
    if left is None:
        return right
    elif right is None:
        return left
    else:
        return {**left, **right}  # æµ…åˆå¹¶ï¼Œright è¦†ç›– left
```

**å…³é”®è®¾è®¡ç‚¹**:
- `NotRequired` - å­—æ®µå¯é€‰ï¼Œå…è®¸ç”¨æˆ·ä¸ä¼  `files`
- `Annotated[..., file_reducer]` - LangGraph ä½¿ç”¨æ­¤å‡½æ•°åˆå¹¶å¹¶è¡Œæ›´æ–°
- æ‰€æœ‰çŠ¶æ€å­—æ®µéƒ½æ˜¯ä¸å¯å˜æ“ä½œï¼ˆè¿”å›æ–°å¯¹è±¡ï¼‰

### 2. å·¥å…·å®ç°

#### write_todos

```python
@tool(description=WRITE_TODOS_TOOL_DESCRIPTION)
def write_todos(
    todos: list[Todo],
    tool_call_id: Annotated[str, InjectedToolCallId]
) -> Command:
    return Command(
        update={
            "todos": todos,  # å®Œå…¨æ›¿æ¢ todos åˆ—è¡¨
            "messages": [
                ToolMessage(
                    f"Updated todo list to {todos}",
                    tool_call_id=tool_call_id
                )
            ],
        }
    )
```

**ç‰¹ç‚¹**:
- è¿”å› `Command` è€Œéå­—ç¬¦ä¸² â†’ ç›´æ¥æ›´æ–°çŠ¶æ€
- å®Œå…¨æ›¿æ¢ todosï¼ˆéå¢é‡æ›´æ–°ï¼‰
- LLM è´Ÿè´£ç®¡ç†æ•´ä¸ª todos åˆ—è¡¨

#### read_file

```python
@tool(description=READ_FILE_TOOL_DESCRIPTION)
def read_file(
    file_path: str,
    state: Annotated[FilesystemState, InjectedState],  # æ³¨å…¥çŠ¶æ€
    offset: int = 0,      # è¡Œåç§»
    limit: int = 2000,    # æœ€å¤šè¯»å–è¡Œæ•°
) -> str:
    mock_filesystem = state.get("files", {})

    if file_path not in mock_filesystem:
        return f"Error: File '{file_path}' not found"

    content = mock_filesystem[file_path]
    lines = content.splitlines()

    # åº”ç”¨åˆ†é¡µ
    start_idx = offset
    end_idx = min(start_idx + limit, len(lines))

    # æ ¼å¼åŒ–è¾“å‡º (æ¨¡æ‹Ÿ cat -n)
    result_lines = []
    for i in range(start_idx, end_idx):
        line_content = lines[i][:2000]  # æˆªæ–­é•¿è¡Œ
        line_number = i + 1
        result_lines.append(f"{line_number:6d}\t{line_content}")

    return "\n".join(result_lines)
```

**å…³é”®ç‚¹**:
- `InjectedState` - LangGraph è‡ªåŠ¨æ³¨å…¥å½“å‰çŠ¶æ€
- æ”¯æŒå¤§æ–‡ä»¶åˆ†é¡µè¯»å–
- è¿”å›å¸¦è¡Œå·çš„æ ¼å¼ï¼ˆå…¼å®¹ Claude Code ä¹ æƒ¯ï¼‰

#### edit_file

```python
@tool(description=EDIT_FILE_TOOL_DESCRIPTION)
def edit_file(
    file_path: str,
    old_string: str,
    new_string: str,
    state: Annotated[FilesystemState, InjectedState],
    tool_call_id: Annotated[str, InjectedToolCallId],
    replace_all: bool = False,
) -> Union[Command, str]:
    mock_filesystem = state.get("files", {})

    if file_path not in mock_filesystem:
        return f"Error: File '{file_path}' not found"

    content = mock_filesystem[file_path]

    # å”¯ä¸€æ€§æ£€æŸ¥
    if not replace_all:
        occurrences = content.count(old_string)
        if occurrences > 1:
            return f"Error: String appears {occurrences} times. Use replace_all=True"

    # æ‰§è¡Œæ›¿æ¢
    if replace_all:
        new_content = content.replace(old_string, new_string)
    else:
        new_content = content.replace(old_string, new_string, 1)

    mock_filesystem[file_path] = new_content

    return Command(
        update={
            "files": mock_filesystem,
            "messages": [ToolMessage("Success", tool_call_id=tool_call_id)]
        }
    )
```

**è®¾è®¡æ¨¡å¼**:
- å­—ç¬¦ä¸²ç²¾ç¡®æ›¿æ¢ï¼ˆéæ­£åˆ™ï¼‰
- å”¯ä¸€æ€§ä¿æŠ¤ - é¿å…è¯¯æ›¿æ¢
- è¿”å›ç±»å‹ `Union[Command, str]` - é”™è¯¯è¿”å›å­—ç¬¦ä¸²ï¼ŒæˆåŠŸè¿”å› Command

### 3. Middleware æ¶æ„

#### åŸºç±»æ¥å£

```python
class AgentMiddleware:
    state_schema: Type[AgentState] = None  # æ‰©å±•çŠ¶æ€æ¨¡å¼
    tools: list[BaseTool] = []             # æä¾›çš„å·¥å…·

    def modify_model_request(
        self,
        request: ModelRequest,
        agent_state: AgentState,
        runtime: Runtime
    ) -> ModelRequest:
        """åœ¨è°ƒç”¨æ¨¡å‹å‰ä¿®æ”¹è¯·æ±‚"""
        return request

    # è¿˜æœ‰å…¶ä»– hooks: before_tools, after_tools, etc.
```

#### PlanningMiddleware å®ç°

```python
class PlanningMiddleware(AgentMiddleware):
    state_schema = PlanningState  # æ‰©å±• todos å­—æ®µ
    tools = [write_todos]         # æä¾›å·¥å…·

    def modify_model_request(
        self,
        request: ModelRequest,
        agent_state: PlanningState,
        runtime: Runtime
    ) -> ModelRequest:
        # æ³¨å…¥ TODO ç®¡ç†æŒ‡ä»¤
        request.system_prompt = (
            request.system_prompt +
            "\n\n" +
            WRITE_TODOS_SYSTEM_PROMPT
        )
        return request
```

**è¦ç‚¹**:
- `state_schema` - å£°æ˜å¼çŠ¶æ€æ‰©å±•
- `tools` - è‡ªåŠ¨æ³¨å†Œåˆ° Agent
- `modify_model_request` - ä¿®æ”¹ç³»ç»Ÿæç¤ºè¯

#### SubAgentMiddleware åŠ¨æ€å·¥å…·ç”Ÿæˆ

```python
class SubAgentMiddleware(AgentMiddleware):
    def __init__(self, default_subagent_tools, subagents, model, is_async):
        super().__init__()
        # åŠ¨æ€åˆ›å»º task å·¥å…·ï¼ˆé—­åŒ…æ•è· subagentsï¼‰
        task_tool = create_task_tool(
            default_subagent_tools=default_subagent_tools,
            subagents=subagents,
            model=model,
            is_async=is_async,
        )
        self.tools = [task_tool]

def create_task_tool(default_subagent_tools, subagents, model, is_async):
    # åˆå§‹åŒ–æ‰€æœ‰ SubAgent å®ä¾‹
    agents = _get_agents(default_subagent_tools, subagents, model)

    # ç”Ÿæˆ SubAgent æè¿°å­—ç¬¦ä¸²
    other_agents_string = _get_subagent_description(subagents)

    # æ ¹æ®åŒæ­¥/å¼‚æ­¥è¿”å›ä¸åŒå®ç°
    if is_async:
        @tool(description=TASK_TOOL_DESCRIPTION.format(...))
        async def task(description, subagent_type, state, tool_call_id):
            sub_agent = agents[subagent_type]
            result = await sub_agent.ainvoke(...)
            return Command(update={...})
    else:
        @tool(description=TASK_TOOL_DESCRIPTION.format(...))
        def task(description, subagent_type, state, tool_call_id):
            sub_agent = agents[subagent_type]
            result = sub_agent.invoke(...)
            return Command(update={...})

    return task
```

**å…³é”®æŠ€æœ¯**:
- åŠ¨æ€ `@tool` è£…é¥°å™¨ï¼ˆè¿è¡Œæ—¶ç”Ÿæˆï¼‰
- é—­åŒ…æ•è· `agents` å­—å…¸
- åŒæ­¥/å¼‚æ­¥åŒå®ç°

### 4. SubAgent ç±»å‹ç³»ç»Ÿ

#### ä¸¤ç§ SubAgent ç±»å‹

```python
# types.py

# ç±»å‹ 1: åŸºäº Prompt çš„ SubAgent (æ›´å¸¸ç”¨)
class SubAgent(TypedDict):
    name: str                           # å¦‚ "research-analyst"
    description: str                    # ç»™ä¸» Agent çœ‹çš„åŠŸèƒ½æè¿°
    prompt: str                         # SubAgent çš„ç³»ç»Ÿæç¤ºè¯
    tools: NotRequired[list[BaseTool]]  # å¯é€‰å·¥å…·åˆ—è¡¨
    model: NotRequired[Union[           # å¯é€‰æ¨¡å‹è¦†ç›–
        LanguageModelLike,              #   - æ¨¡å‹å®ä¾‹
        dict[str, Any]                  #   - æˆ–é…ç½®å­—å…¸
    ]]
    middleware: NotRequired[list[AgentMiddleware]]  # é¢å¤–ä¸­é—´ä»¶

# ç±»å‹ 2: åŸºäº Graph çš„ SubAgent (é«˜çº§ç”¨æ³•)
class CustomSubAgent(TypedDict):
    name: str                           # å¦‚ "complex-workflow"
    description: str                    # ç»™ä¸» Agent çœ‹çš„åŠŸèƒ½æè¿°
    graph: Runnable                     # é¢„æ„å»ºçš„ LangGraph å›¾
```

#### SubAgent å®ä¾‹åŒ–é€»è¾‘

```python
def _get_agents(default_subagent_tools, subagents, model):
    # é»˜è®¤ä¸­é—´ä»¶ (SubAgent å…±äº«)
    default_subagent_middleware = [
        PlanningMiddleware(),
        FilesystemMiddleware(),
        # æ³¨æ„: æ²¡æœ‰ SubAgentMiddleware (é¿å…æ— é™é€’å½’)
        SummarizationMiddleware(...),
        AnthropicPromptCachingMiddleware(...)
    ]

    # 1. åˆ›å»ºå†…ç½® general-purpose SubAgent
    agents = {
        "general-purpose": create_agent(
            model,
            system_prompt=BASE_AGENT_PROMPT,
            tools=default_subagent_tools,  # ç»§æ‰¿ä¸» Agent å·¥å…·
            middleware=default_subagent_middleware,
            checkpointer=False  # SubAgent ä¸æŒä¹…åŒ–
        )
    }

    # 2. å®ä¾‹åŒ–ç”¨æˆ·è‡ªå®šä¹‰ SubAgents
    for _agent in subagents:
        if "graph" in _agent:
            # CustomSubAgent - ç›´æ¥ä½¿ç”¨é¢„æ„å»ºå›¾
            agents[_agent["name"]] = _agent["graph"]
            continue

        # SubAgent - æ„å»ºæ–° Agent
        _tools = _agent.get("tools", default_subagent_tools.copy())

        # æ¨¡å‹è§£æ
        if "model" in _agent:
            agent_model = _agent["model"]
            if isinstance(agent_model, dict):
                # å­—å…¸é…ç½® â†’ åˆå§‹åŒ–æ¨¡å‹
                sub_model = init_chat_model(**agent_model)
            else:
                # æ¨¡å‹å®ä¾‹ â†’ ç›´æ¥ä½¿ç”¨
                sub_model = agent_model
        else:
            # ç»§æ‰¿ä¸» Agent æ¨¡å‹
            sub_model = model

        # ä¸­é—´ä»¶åˆå¹¶
        if "middleware" in _agent:
            _middleware = [
                *default_subagent_middleware,
                *_agent["middleware"]
            ]
        else:
            _middleware = default_subagent_middleware

        # æ„å»º SubAgent
        agents[_agent["name"]] = create_agent(
            sub_model,
            system_prompt=_agent["prompt"],
            tools=_tools,
            middleware=_middleware,
            checkpointer=False
        )

    return agents
```

---

## Linus å¼ä»£ç å“å‘³åˆ†æ

### âœ… å¥½å“å‘³ (Good Taste)

#### 1. **æ•°æ®ç»“æ„é©±åŠ¨è®¾è®¡**
```python
# state.py
class DeepAgentState(AgentState):
    todos: NotRequired[list[Todo]]
    files: Annotated[NotRequired[dict[str, str]], file_reducer]
```

**è¯„ä»·**:
- âœ… çŠ¶æ€æ˜¯ç¬¬ä¸€å…¬æ°‘ï¼Œæ‰€æœ‰ç»„ä»¶å›´ç»• State è®¾è®¡
- âœ… ä½¿ç”¨ `Annotated` + Reducer ä¼˜é›…å¤„ç†å¹¶å‘æ›´æ–°
- âœ… `NotRequired` è®©æ¥å£çµæ´»ä½†ç±»å‹å®‰å…¨

#### 2. **å·¥å…·è¿”å› Command è€Œéå‰¯ä½œç”¨**
```python
# tools.py
@tool
def write_file(...) -> Command:
    return Command(
        update={
            "files": new_files,
            "messages": [ToolMessage(...)]
        }
    )
```

**è¯„ä»·**:
- âœ… å‡½æ•°å¼è®¾è®¡ - è¿”å›æ•°æ®è€Œéä¿®æ”¹å…¨å±€çŠ¶æ€
- âœ… å¯æµ‹è¯•æ€§å¼º - å·¥å…·æ˜¯çº¯å‡½æ•°
- âœ… LangGraph ç»Ÿä¸€å¤„ç†çŠ¶æ€æ›´æ–°

#### 3. **ä¸­é—´ä»¶çš„å£°æ˜å¼æ‰©å±•**
```python
class PlanningMiddleware(AgentMiddleware):
    state_schema = PlanningState  # å£°æ˜æ‰©å±•å­—æ®µ
    tools = [write_todos]         # å£°æ˜æä¾›å·¥å…·
```

**è¯„ä»·**:
- âœ… ç»„åˆä¼˜äºç»§æ‰¿
- âœ… æ¯ä¸ªä¸­é—´ä»¶èŒè´£å•ä¸€
- âœ… æ˜“äºæ·»åŠ /åˆ é™¤åŠŸèƒ½

### ğŸŸ¡ å‡‘åˆ (Acceptable but Smelly)

#### 1. **SubAgent åŒç±»å‹è®¾è®¡**
```python
class SubAgent(TypedDict): ...
class CustomSubAgent(TypedDict): ...

# ä½¿ç”¨æ—¶éœ€è¦æ¡ä»¶åˆ¤æ–­
if "graph" in _agent:
    agents[name] = _agent["graph"]
else:
    agents[name] = create_agent(...)
```

**é—®é¢˜**:
- ğŸŸ¡ è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥ (`if "graph" in _agent`)
- ğŸŸ¡ ä¸¤ç§é…ç½®æ–¹å¼å¢åŠ è®¤çŸ¥è´Ÿæ‹…

**Linus å»ºè®®**:
```python
# ç»Ÿä¸€æ¥å£
class SubAgent:
    name: str
    description: str

    @abstractmethod
    def get_executor(self) -> Runnable:
        pass

class PromptBasedSubAgent(SubAgent):
    def get_executor(self):
        return create_agent(...)

class GraphBasedSubAgent(SubAgent):
    def get_executor(self):
        return self.graph
```

#### 2. **åŒæ­¥/å¼‚æ­¥ä»£ç é‡å¤**
```python
# graph.py
def create_deep_agent(...):
    return agent_builder(..., is_async=False)

def async_create_deep_agent(...):
    return agent_builder(..., is_async=True)

# middleware.py
if is_async:
    @tool
    async def task(...):
        result = await sub_agent.ainvoke(...)
else:
    @tool
    def task(...):
        result = sub_agent.invoke(...)
```

**é—®é¢˜**:
- ğŸŸ¡ ä»£ç é‡å¤ - è¿å DRY
- ğŸŸ¡ ç»´æŠ¤æˆæœ¬ - ä¸¤å¤„ä¿®æ”¹

**Linus å»ºè®®**:
```python
# åªæä¾›å¼‚æ­¥ç‰ˆæœ¬
def create_deep_agent(...):
    return async_create_deep_agent(...)

# æˆ–ä½¿ç”¨é€‚é…å™¨æ¨¡å¼
class SyncWrapper:
    def __init__(self, async_agent):
        self.agent = async_agent

    def invoke(self, *args, **kwargs):
        return asyncio.run(self.agent.ainvoke(*args, **kwargs))
```

### ğŸ”´ ç³Ÿç³• (Bad Taste)

#### 1. **è¿‡åº¦ä¾èµ– Prompt Engineering**
```python
# prompts.py - 25KB+ çš„æç¤ºè¯æ–‡ä»¶
WRITE_TODOS_SYSTEM_PROMPT = """
## When to Use This Tool
Use this tool in these scenarios:
1. Complex multi-step tasks...
2. Non-trivial and complex tasks...
...
(400+ lines of instructions)
"""
```

**é—®é¢˜**:
- ğŸ”´ æ§åˆ¶é€»è¾‘åŸ‹åœ¨è‡ªç„¶è¯­è¨€é‡Œ
- ğŸ”´ éš¾ä»¥æµ‹è¯•å’ŒéªŒè¯
- ğŸ”´ Prompt å˜åŒ–å¯èƒ½ç ´åè¡Œä¸º

**Linus è§‚ç‚¹**:
> "å¦‚æœä½ çš„ç³»ç»Ÿä¸¥é‡ä¾èµ–ä¸€ä¸ª magic prompt æ‰èƒ½å·¥ä½œï¼Œé‚£è¯´æ˜ä½ çš„æ•°æ®ç»“æ„å’Œæ§åˆ¶æµè®¾è®¡æœ‰é—®é¢˜ã€‚"

**é‡æ„æ–¹å‘**:
```python
class PlanningController:
    def should_create_todos(self, task: Task) -> bool:
        """ä»£ç é€»è¾‘å†³å®šä½•æ—¶ä½¿ç”¨ TODO"""
        return (
            task.step_count >= 3 or
            task.complexity > Complexity.MEDIUM or
            task.has_subtasks
        )

    def auto_decompose_task(self, task: Task) -> list[Todo]:
        """ä»£ç è‡ªåŠ¨æ‹†è§£ä»»åŠ¡ï¼Œè€Œéè®© LLM çŒœ"""
        if task.type == TaskType.RESEARCH:
            return self._decompose_research(task)
        elif task.type == TaskType.CODING:
            return self._decompose_coding(task)
        ...
```

#### 2. **è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„å‘½åä¸è¯šå®**
```python
# ä»£ç å®ç°
files: dict[str, str]  # åªæ˜¯ä¸€ä¸ªå­—å…¸

# æ–‡æ¡£å£°æ˜
"You have access to a local, private **filesystem**"
"Right now the 'file system' will only be one level deep (no sub directories)"
```

**é—®é¢˜**:
- ğŸ”´ åå­—æ’’è° - è¿™ä¸æ˜¯æ–‡ä»¶ç³»ç»Ÿï¼Œæ˜¯é”®å€¼å­˜å‚¨
- ğŸ”´ ç”¨æˆ·æœŸæœ›æ–‡ä»¶ç³»ç»ŸåŠŸèƒ½ï¼ˆç›®å½•ã€è·¯å¾„ã€æƒé™ï¼‰ä½†éƒ½ä¸æ”¯æŒ

**Linus è§‚ç‚¹**:
> "å¦‚æœä½ çš„ä¸œè¥¿ä¸æ”¯æŒç›®å½•ï¼Œå°±åˆ«å«å®ƒæ–‡ä»¶ç³»ç»Ÿã€‚å«å®ƒ 'document store' æˆ– 'artifact cache'ã€‚"

**æ­£ç¡®å‘½å**:
```python
class ArtifactStore(AgentMiddleware):
    """å­˜å‚¨ Agent ç”Ÿæˆçš„æ–‡æ¡£å’Œæ•°æ®"""
    state_schema = ArtifactState
    tools = [
        list_artifacts,
        read_artifact,
        write_artifact,
        update_artifact
    ]
```

#### 3. **æ–‡ä»¶åªè¯»æ£€æŸ¥ç¼ºå¤±**
```python
# tools.py
@tool
def edit_file(file_path, old_string, new_string, state, ...):
    mock_filesystem = state.get("files", {})

    if file_path not in mock_filesystem:
        return "Error: File not found"

    # ç›´æ¥ä¿®æ”¹ï¼Œæ²¡æœ‰æ£€æŸ¥æ˜¯å¦æ›¾è¢«è¯»å–
    content = mock_filesystem[file_path]
    new_content = content.replace(old_string, new_string)
    ...
```

**é—®é¢˜**:
- ğŸŸ¡ æ–‡æ¡£è¯´ "You must use Read tool before editing"
- ğŸŸ¡ ä½†ä»£ç æ²¡æœ‰å¼ºåˆ¶æ£€æŸ¥
- ğŸŸ¡ Prompt è¦æ±‚ vs ä»£ç å®ç°ä¸ä¸€è‡´

**æ”¹è¿›**:
```python
class FilesystemState(AgentState):
    files: dict[str, str]
    read_files: set[str]  # è·Ÿè¸ªå·²è¯»æ–‡ä»¶

@tool
def edit_file(...):
    if file_path not in state.get("read_files", set()):
        return "Error: Must read file before editing. Use read_file first."
    ...
```

---

## æ€»ç»“ä¸æ”¹è¿›æ–¹å‘

### æ¶æ„ä¼˜åŠ¿

1. **æ¸…æ™°çš„åˆ†å±‚** - API â†’ Builder â†’ Middleware â†’ Agent â†’ Tools
2. **ç»„åˆå¼è®¾è®¡** - ä¸­é—´ä»¶ç‹¬ç«‹å¯æ’æ‹”
3. **çŠ¶æ€éš”ç¦»** - SubAgent å®ç° context quarantine
4. **LangGraph åŸºç¡€** - å¤ç”¨æˆç†Ÿçš„ Agent æ¡†æ¶

### å…³é”®ç¼ºé™·

| é—®é¢˜ | å½±å“ | ä¼˜å…ˆçº§ |
|------|------|--------|
| è¿‡åº¦ä¾èµ– Prompt | ä¸å¯é¢„æµ‹ã€éš¾æµ‹è¯• | ğŸ”´ P0 |
| è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå‘½åä¸è¯šå® | è¯¯å¯¼ç”¨æˆ·æœŸæœ› | ğŸŸ¡ P1 |
| åŒæ­¥/å¼‚æ­¥ä»£ç é‡å¤ | ç»´æŠ¤æˆæœ¬é«˜ | ğŸŸ¡ P1 |
| SubAgent åŒç±»å‹ | å¢åŠ å¤æ‚åº¦ | ğŸŸ¡ P2 |
| ç¼ºå°‘ç¼–ç¨‹å¼æ§åˆ¶æµ | ä¾èµ– LLM"çŒœ" | ğŸ”´ P0 |

### Linus çš„ç»ˆæå»ºè®®

> **"è¿™ä¸ªé¡¹ç›®çš„æ–¹å‘å¯¹ï¼Œä½†åˆ«æŠŠ Prompt å½“ä¸‡èƒ½è¯ã€‚"**
>
> **ä¸‰ä¸ªå…³é”®æ”¹è¿›ï¼š**
> 1. æŠŠæ§åˆ¶é€»è¾‘ä» Prompt ç§»åˆ°ä»£ç é‡Œ - ç”¨ `PlanningController`, `TaskDecomposer` ç­‰ç±»
> 2. è¯šå®å‘½å - `ArtifactStore` ä¸æ˜¯ `Filesystem`
> 3. æ¶ˆé™¤ç‰¹æ®Šæƒ…å†µ - ç»Ÿä¸€ SubAgent æ¥å£ï¼Œåªæä¾› async API
>
> **å“å‘³æå‡è·¯å¾„ï¼šå‡‘åˆ (6/10) â†’ å¥½ (8/10)**
> - æ•°æ®ç»“æ„å·²ç»ä¸é”™
> - ä½†æ§åˆ¶æµè¿˜åœ¨ Prompt é‡Œæ™ƒè¡
> - æŠŠå®ƒä»¬æ‹‰åˆ°ç±»å‹å®‰å…¨çš„ä»£ç é‡Œï¼Œè¿™ä¸ªé¡¹ç›®å°±èƒ½æˆä¸ºæ•™ç§‘ä¹¦çº§åˆ«çš„è®¾è®¡

---

## é™„å½•: å¿«é€Ÿå‚è€ƒ

### åˆ›å»º Agent æµç¨‹

```python
# 1. å®šä¹‰å·¥å…·
def my_tool(query: str) -> str:
    return do_something(query)

# 2. å®šä¹‰ SubAgent (å¯é€‰)
subagents = [{
    "name": "analyst",
    "description": "æ•°æ®åˆ†æä¸“å®¶",
    "prompt": "ä½ æ˜¯æ•°æ®åˆ†æä¸“å®¶...",
    "tools": [my_tool]
}]

# 3. åˆ›å»º Agent
from deepagents import create_deep_agent

agent = create_deep_agent(
    tools=[my_tool],
    instructions="ä½ æ˜¯ä¸€ä¸ªç ”ç©¶åŠ©æ‰‹",
    subagents=subagents
)

# 4. è°ƒç”¨
result = agent.invoke({
    "messages": [{"role": "user", "content": "å¸®æˆ‘ç ”ç©¶ X"}]
})

# 5. è®¿é—®ç»“æœ
print(result["messages"][-1].content)  # æœ€ç»ˆå“åº”
print(result["files"])                  # ç”Ÿæˆçš„æ–‡ä»¶
print(result["todos"])                  # TODO çŠ¶æ€
```

### çŠ¶æ€æµè½¬é€ŸæŸ¥è¡¨

| é˜¶æ®µ | State Keys | æ“ä½œ |
|------|-----------|------|
| è¾“å…¥ | `messages`, `files?` | ç”¨æˆ·æä¾› |
| è§„åˆ’ | `+todos` | PlanningMiddleware æ·»åŠ  |
| å·¥å…·è°ƒç”¨ | `messages+`, `files*`, `todos*` | å·¥å…·æ›´æ–° |
| SubAgent | éš”ç¦» `messages` | SubAgentMiddleware |
| è¾“å‡º | `messages`, `todos`, `files` | å®Œæ•´çŠ¶æ€ |

*æ³¨: `+` è¿½åŠ , `*` ä¿®æ”¹, `?` å¯é€‰*

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0-20251017123000
**åŸºäºä»£ç **: `/Users/gump_m2/Documents/Agent-RL/xDAN-DeepAgent-People-Searching/src/deepagents`
**ç¬¦åˆæ ‡å‡†**: KISS, DRY, Linus å¥½å“å‘³åŸåˆ™
